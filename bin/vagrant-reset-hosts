#!/bin/sh

HOSTNAME=$1

if [[ -z "$HOSTNAME" || "$HOSTNAME" == "localhost" ]]; then
    echo "Invalid hostname."
    exit -1
fi

IP=`vagrant-ip`
SRC_FILE="/tmp/$RANDOM.hosts"
DEST_FILE="/tmp/$RANDOM.hosts"

if [ -z "$IP" ]; then
    echo "Unable to retrieve IP address for virtual machine."
    exit -1
fi

cp /etc/hosts "$SRC_FILE"

while read line;
do
    echo "$line" | grep --quiet "$HOSTNAME[[:space:]]*$"
    if [ $? -ne 0 ]; then
        echo "$line" >> "$DEST_FILE"
    else
        echo "$IP\t$HOSTNAME" >> "$DEST_FILE"
    fi
done < "$SRC_FILE"

rm "$SRC_FILE"

echo "Replacing /etc/hosts, original will be moved to /etc/hosts.orig"
sudo chown root:wheel "$DEST_FILE" && sudo cp /etc/hosts /etc/hosts.orig  && sudo mv "$DEST_FILE" /etc/hosts
